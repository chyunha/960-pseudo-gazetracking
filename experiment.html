<!DOCTYPE html>
<html>
<head>
    <title>9.60 Final Experiment</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        #image-container img {
            max-width: 90%;
            height: auto;
            cursor: crosshair;
        }
    </style>
</head>

<body>
    <div id="instructions">
        {{image_set["prompt"]}}
        <button onclick="startExperiment()">Start</button>
    </div>

    <div id="image-container" style="display:none;"></div>

    <script id="image-set-data" type="application/json">
        {{image_set | tojson | safe}}
    </script>

    <script>
        const participantId = "{{ participant_id }}";
        const imageSet = JSON.parse(document.getElementById('image-set-data').textContent);
        const imageKeys = Object.keys(imageSet).filter(k => k.startsWith("img"));
        let index = 0;
        let clickData = {};
        let currentImage = "";

        function startExperiment() {
            document.getElementById('instructions').style.display = 'none';
            document.getElementById('image-container').style.display = 'block';
            showNextImage();
        }

        const imageElement = document.getElementById("experiment-image");

        function showNextImage() {
        if (index >= imageKeys.length) {
            submitData();
            return;
        }

        const imageName = imageSet[imageKeys[index]];
        currentImage = imageName;
        imageElement.src = `static/stimuli/${imageName}.jpg`;
        clickData[imageName] = [];

        setTimeout(() => {
            index++;
            showNextImage();
        }, 5000); // 5 seconds per image
        }

        imageElement.addEventListener('click', (e) => {
        const rect = imageElement.getBoundingClientRect();
        clickData[currentImage].push({
            x: e.clientX - rect.left,
            y: e.clientY - rect.top,
            timestamp: Date.now()
        });
        });

        function submitData() {
        fetch('/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
            participant_id: participantId,
            click_data: clickData
            })
        }).then(res => {
            if (res.ok) {
            document.body.innerHTML = "<h2>Thank you for participating!</h2>";
            } else {
            alert("Error saving your data.");
            }
        });
        }

        showNextImage();
    </script>
</body>

</html>